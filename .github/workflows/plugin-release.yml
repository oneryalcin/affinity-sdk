name: Release MCP Plugin

on:
  push:
    tags: ["plugin-v*.*.*"]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., plugin-v1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install mcp-bash framework
        run: |
          # Source version and commit from lockfile (single source of truth)
          source mcp/mcp-bash.lock
          echo "Installing mcp-bash v${MCPBASH_VERSION} (${MCPBASH_COMMIT})"
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/main/install.sh | \
            bash -s -- --version "v${MCPBASH_VERSION}" --yes
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verify installed commit matches lockfile
          INSTALLED_COMMIT=$(git -C "${XDG_DATA_HOME:-$HOME/.local/share}/mcp-bash" rev-parse HEAD)
          if [[ "$INSTALLED_COMMIT" != "$MCPBASH_COMMIT" ]]; then
            echo "::error::mcp-bash commit mismatch: expected $MCPBASH_COMMIT, got $INSTALLED_COMMIT"
            exit 1
          fi

      - name: Verify mcp-bash installation
        run: mcp-bash --version

      - name: Build Claude Code plugin ZIP
        run: |
          cd mcp
          make plugin
          echo "Plugin version: $(cat .claude-plugin/VERSION)"
          ls -la .claude-plugin/xaffinity-mcp-plugin.zip

      - name: Validate MCPB configuration
        run: |
          cd mcp
          mcp-bash bundle --validate

      - name: Build MCPB bundle
        run: |
          cd mcp
          mcp-bash bundle --output dist --verbose
          ls -la dist/*.mcpb

      - name: Validate MCPB bundle structure
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          unzip -t "$MCPB_FILE"
          unzip -p "$MCPB_FILE" manifest.json | jq .
          echo "MCPB bundle validated"

      - name: Test MCPB bundle health check
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          EXTRACT_DIR=$(mktemp -d)
          unzip -q "$MCPB_FILE" -d "$EXTRACT_DIR"
          "$EXTRACT_DIR/server/run-server.sh" --health || echo "Health check not available (expected if CLI not configured)"
          rm -rf "$EXTRACT_DIR"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            mcp/.claude-plugin/xaffinity-mcp-plugin.zip
            mcp/dist/*.mcpb
          generate_release_notes: true
          name: MCP Plugin ${{ github.event.inputs.tag || github.ref_name }}
          body: |
            ## Installation

            ### One-click install (Claude Desktop)
            Download `xaffinity-mcp-*.mcpb` and double-click or drag to Claude Desktop.

            ### Claude Code
            ```bash
            /plugin marketplace add yaniv-golan/affinity-sdk
            /plugin install mcp@xaffinity
            ```

            ### Manual configuration
            Download `xaffinity-mcp-plugin.zip` and configure your MCP client manually.
            See [documentation](https://yaniv-golan.github.io/affinity-sdk/latest/mcp/) for details.
