name: Release MCP Plugin

on:
  push:
    tags: ["mcp-v*.*.*"]  # Renamed from plugin-v*
  workflow_call:
    inputs:
      version:
        description: "Version to release (without prefix)"
        required: true
        type: string
      triggered_by:
        description: "What triggered this release"
        required: false
        type: string
        default: "tag"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., mcp-v1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Determine version and tag
        id: version
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.version }}" ]]; then
            # Called via workflow_call
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag_name=mcp-v${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "is_workflow_call=true" >> $GITHUB_OUTPUT
            echo "Mode: workflow_call, version=${{ inputs.version }}"
          else
            # Called via tag push or workflow_dispatch
            TAG_NAME="${{ github.event.inputs.tag || github.ref_name }}"
            VERSION="${TAG_NAME#mcp-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "is_workflow_call=false" >> $GITHUB_OUTPUT
            echo "Mode: tag/dispatch, tag=$TAG_NAME, version=$VERSION"
          fi

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.version.outputs.is_workflow_call == 'true' && 'main' || (github.event.inputs.tag || github.ref) }}

      - name: Validate version matches VERSION file
        run: |
          set -euo pipefail
          FILE_VERSION=$(cat mcp/VERSION | tr -d '[:space:]')
          INPUT_VERSION="${{ steps.version.outputs.version }}"
          if [[ "$FILE_VERSION" != "$INPUT_VERSION" ]]; then
            echo "::error::Version mismatch: mcp/VERSION=$FILE_VERSION, expected=$INPUT_VERSION"
            exit 1
          fi
          echo "Version validated: $FILE_VERSION"

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install mcp-bash framework
        run: |
          # Source version and commit from lockfile (single source of truth)
          source mcp/mcp-bash.lock
          echo "Installing mcp-bash v${MCPBASH_VERSION} (${MCPBASH_COMMIT})"
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/main/install.sh | \
            bash -s -- --version "v${MCPBASH_VERSION}" --yes
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verify installed commit matches lockfile
          INSTALLED_COMMIT=$(git -C "${XDG_DATA_HOME:-$HOME/.local/share}/mcp-bash" rev-parse HEAD)
          if [[ "$INSTALLED_COMMIT" != "$MCPBASH_COMMIT" ]]; then
            echo "::error::mcp-bash commit mismatch: expected $MCPBASH_COMMIT, got $INSTALLED_COMMIT"
            exit 1
          fi

      - name: Verify mcp-bash installation
        run: mcp-bash --version

      - name: Build Claude Code plugin ZIP
        run: |
          cd mcp
          make plugin
          echo "Plugin version: $(cat .claude-plugin/VERSION)"
          ls -la .claude-plugin/xaffinity-mcp-plugin.zip

      - name: Validate MCPB configuration
        run: |
          cd mcp
          mcp-bash bundle --validate

      - name: Build MCPB bundle
        run: |
          cd mcp
          mcp-bash bundle --output dist --verbose
          ls -la dist/*.mcpb

      - name: Validate MCPB bundle structure
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          unzip -t "$MCPB_FILE"
          unzip -p "$MCPB_FILE" manifest.json | jq .
          echo "MCPB bundle validated"

      - name: Test MCPB bundle health check
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          EXTRACT_DIR=$(mktemp -d)
          unzip -q "$MCPB_FILE" -d "$EXTRACT_DIR"
          "$EXTRACT_DIR/server/run-server.sh" --health || echo "Health check not available (expected if CLI not configured)"
          rm -rf "$EXTRACT_DIR"

      - name: Create and push tag
        if: steps.version.outputs.is_workflow_call == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Release ${{ steps.version.outputs.tag_name }}"
          git push origin "${{ steps.version.outputs.tag_name }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          files: |
            mcp/.claude-plugin/xaffinity-mcp-plugin.zip
            mcp/dist/*.mcpb
          generate_release_notes: true
          name: MCP Server ${{ steps.version.outputs.tag_name }}
          body: |
            ## Installation

            ### One-click install (Claude Desktop)
            Download `xaffinity-mcp-*.mcpb` and double-click or drag to Claude Desktop.

            ### Claude Code
            ```bash
            /plugin marketplace add yaniv-golan/affinity-sdk
            /plugin install mcp@xaffinity
            ```

            ### Manual configuration
            Download `xaffinity-mcp-plugin.zip` and configure your MCP client manually.
            See [documentation](https://yaniv-golan.github.io/affinity-sdk/latest/mcp/) for details.
