# Affinity SDK Audit Report

**Date:** 2025-12-20T23:54:36Z
**Commit:** 1bb991745ae236d54531e46c9735608075653ac8
**Mode:** Full Audit
**Agents Used:** 8 specialized auditors

## Executive Summary

| Severity | Count |
|----------|-------|
| Critical | 1 |
| High | 15 |
| Medium | 17 |
| Low | 16 |
| Info | 47 |
| **Total** | **96** |

**Key Findings:**
- **CLI Feature Gaps**: OpportunityService has no CLI commands (Critical)
- **Async Parity**: Multiple async services missing sync counterpart methods (7 High)
- **Documentation**: Example files have runtime errors due to FieldValues API changes (4 High)
- **Test Coverage**: Async V1-only services lack test coverage (5 Medium)

## Validation Results (2025-12-21)

Validated against the current working tree (main + ahead 4). Status meanings:
**Valid** = still present, **Invalid** = resolved, **Partial** = partially addressed.

### Critical
- **CLI-001**: **Implemented** — opportunity CLI group added:
  - `affinity/cli/commands/opportunity_cmds.py`
  - registered in `affinity/cli/main.py`
  - documented in `docs/public/cli/commands.md`

### High
- **API-001/002/003/004**: **Implemented** — `AsyncCompanyService` now mirrors sync:
  create/update/delete, merge/get_merge_status, search/search_pages/search_all/resolve,
  get_list_entries/get_lists/get_fields (`affinity/services/companies.py`).
- **API-005**: **Implemented** — AsyncPersonService now mirrors sync (search/resolve, helpers,
  write ops, merge ops) (`affinity/services/persons.py`).
- **API-006**: **Implemented** — `AsyncListService` now exposes create/get_fields
  (`affinity/services/lists.py`).
- **API-007**: **Implemented** — `AsyncListEntryService` now exposes write ops and field value helpers
  (`affinity/services/lists.py`).
- **CLI-002/003/005**: **Implemented** — CLI modules added for notes/reminders/interactions
  under `affinity/cli/commands/`.
- **CLI-004**: **Valid** — webhook CLI commands intentionally omitted.
- **DOC-001**: **Implemented** — `examples/basic_usage.py` updated to use `company.fields.data`.
- **DOC-002**: **Implemented** — `examples/list_management.py` updated to use `entry.fields.data`.
- **DOC-003**: **Implemented** — `examples/list_management.py` no longer references `filter_text`.
- **DOC-004**: **Implemented** — `examples/advanced_usage.py` updated to use `fields.data`.

### Medium
- **TC-001**: **Valid** — no `@pytest.mark.req('FR-002')` found in `tests/`.
- **TC-002–TC-005**: **Valid** — no async tests for v1-only services
  (`AsyncNoteService`, `AsyncReminderService`, `AsyncWebhookService`, `AsyncInteractionService`).
- **CLI-006–CLI-014**: **Implemented** — CLI now exposes create/update/delete/merge plus
  field/field-value/relationship-strength/task commands (see `affinity/cli/commands/`).
- **ERR-007**: **Implemented** — list service response parsing now wraps
  `model_validate()` to raise `AffinityError` on invalid API payloads
  (`affinity/services/lists.py`).
- **DEP-001/DEP-002**: **Valid** — `pyproject.toml` still has lower bounds only for httpx/pydantic.
- **DOC-005**: **Valid** — `docs/public/guides/sync-vs-async.md` parity table still omits rate_limits.

### Low
- **API-013**: **Valid** — AsyncEntityFileService.download() has `deadline_seconds` mismatch
  (`affinity/services/v1_only.py:1566+`).
- **TC-006–TC-010**: **Valid** — async tests missing for field/field_values/relationship_strength/
  rate_limit/auth services.
- **CLI-015–CLI-018**: **Valid** — no CLI list commands for person/company; upload commands still
  missing for entity files; search params still not exposed.
- **SEC-002**: **Valid** — webhook sent_at validation still absent (`affinity/inbound_webhooks.py:171`).
- **ERR-004**: **Valid** — no thundering herd prevention for rate limits
  (`affinity/clients/http.py:784`).
- **DEP-003**: **Valid** — `rich` dependency still uses lower bound only (`pyproject.toml:54`).
- **DOC-006/DOC-007**: **Valid** — README still prints FieldValues repr in examples
  (`README.md:100, 176`).

### Positive Findings
- Not re-validated in this pass. No conflicting evidence observed in the checked areas above.

## Cross-Agent Findings (High Confidence)

### Async Service Methods Missing + No Tests
**Flagged by:** api-parity-auditor, test-coverage-auditor

The async variants of V1-only services (AsyncNoteService, AsyncReminderService, etc.) are missing methods that exist in their sync counterparts. Additionally, these async services have no dedicated test coverage, compounding the risk.

**Files affected:**
- `affinity/services/v1_only.py` (lines 1070-1867)
- `tests/` (missing async tests)

**Recommendation:** Implement missing async methods AND add test coverage simultaneously.

---

## Critical Issues (Must Fix)

### CLI-001: OpportunityService has no CLI commands
**Auditor:** sdk-cli-consistency-auditor | **File:** affinity/cli/commands/

**Status:** Implemented (2025-12-21)

Opportunity CLI group now exists:
- `affinity/cli/commands/opportunity_cmds.py` with `ls/get/create/update/delete`
- Registered in `affinity/cli/main.py`
- Documented in `docs/public/cli/commands.md`

---

## High Priority Issues

### API-001: AsyncCompanyService missing write operations (create, update, delete)
**Auditor:** api-parity-auditor | **File:** affinity/services/companies.py:525

**Status:** Implemented (2025-12-21)

AsyncCompanyService now exposes:
- `create(...)`
- `update(...)`
- `delete(...)`

---

### API-002: AsyncCompanyService missing merge operations
**Auditor:** api-parity-auditor | **File:** affinity/services/companies.py:525

**Status:** Implemented (2025-12-21)

AsyncCompanyService now exposes:
- `merge(...)`
- `get_merge_status(...)`

---

### API-003: AsyncCompanyService missing search operations
**Auditor:** api-parity-auditor | **File:** affinity/services/companies.py:525

**Status:** Implemented (2025-12-21)

AsyncCompanyService now exposes:
- `search(...)`
- `search_pages(...)`
- `search_all(...)`
- `resolve(...)`

---

### API-004: AsyncCompanyService missing get_list_entries, get_lists, get_fields
**Auditor:** api-parity-auditor | **File:** affinity/services/companies.py:525

**Status:** Implemented (2025-12-21)

AsyncCompanyService now exposes:
- `get_list_entries(...)`
- `get_lists(...)`
- `get_fields(...)`

---

### API-005: AsyncPersonService missing all write/search/helper methods
**Auditor:** api-parity-auditor | **File:** affinity/services/persons.py:470

**Status:** Implemented (2025-12-21)

AsyncPersonService now exposes:
- `get_list_entries(...)`, `get_lists(...)`, `get_fields(...)`
- `search(...)`, `search_pages(...)`, `search_all(...)`, `resolve(...)`
- `create(...)`, `update(...)`, `delete(...)`
- `merge(...)`, `get_merge_status(...)`

---

### API-006: AsyncListService missing create() and get_fields()
**Auditor:** api-parity-auditor | **File:** affinity/services/lists.py:793

**Status:** Implemented (2025-12-21)

AsyncListService now exposes:
- `create(...)`
- `get_fields(...)`

---

### API-007: AsyncListEntryService missing write operations and field value methods
**Auditor:** api-parity-auditor | **File:** affinity/services/lists.py:1043

**Status:** Implemented (2025-12-21)

AsyncListEntryService now exposes:
- `ensure_person(...)`, `ensure_company(...)`
- `add_person(...)`, `add_company(...)`, `add_opportunity(...)`
- `delete(...)`
- `get_field_values(...)`, `get_field_value(...)`
- `update_field_value(...)`, `batch_update_fields(...)`

---

### CLI-002: NoteService has no CLI commands
**Auditor:** sdk-cli-consistency-auditor | **File:** affinity/cli/commands/

**Status:** Implemented (2025-12-21)

CLI now exposes:
- `affinity note ls|get|create|update|delete`

---

### CLI-003: ReminderService has no CLI commands
**Auditor:** sdk-cli-consistency-auditor | **File:** affinity/cli/commands/

**Status:** Implemented (2025-12-21)

CLI now exposes:
- `affinity reminder ls|get|create|update|delete`

---

### CLI-004: WebhookService has no CLI commands
**Auditor:** sdk-cli-consistency-auditor | **File:** affinity/cli/commands/

---

### CLI-005: InteractionService has no CLI commands
**Auditor:** sdk-cli-consistency-auditor | **File:** affinity/cli/commands/

**Status:** Implemented (2025-12-21)

CLI now exposes:
- `affinity interaction ls|get|create|update|delete`

---

### DOC-001: basic_usage.py uses len() on FieldValues which has no __len__
**Auditor:** documentation-auditor | **File:** examples/basic_usage.py:44

The example code uses `len(company.fields)` but `company.fields` is a `FieldValues` object which does not implement `__len__`. This will raise `TypeError` at runtime.

**Fix:** Change to `len(company.fields.data)` to access the underlying dict.

**Status:** Implemented (2025-12-21)

---

### DOC-002: list_management.py uses .items() on FieldValues object
**Auditor:** documentation-auditor | **File:** examples/list_management.py:69

The example code uses `entry.fields.items()` but FieldValues does not have an `items()` method.

**Fix:** Change to `entry.fields.data.items()`.

**Status:** Implemented (2025-12-21)

---

### DOC-003: list_management.py references non-existent SavedView.filter_text
**Auditor:** documentation-auditor | **File:** examples/list_management.py:79

The SavedView model does not have a `filter_text` attribute.

**Status:** Implemented (2025-12-21)

---

### DOC-004: advanced_usage.py uses .get() and .items() on FieldValues
**Auditor:** documentation-auditor | **File:** examples/advanced_usage.py:85

Multiple locations access FieldValues as if it were a dict.

**Status:** Implemented (2025-12-21)

---

## Medium Priority Issues

### TC-001: FR-002 (V2-First Architecture) lacks explicit req marker
**Auditor:** test-coverage-auditor | **File:** tests/

Requirement FR-002 specifies V2-First Architecture principles, but no test is explicitly tagged with `@pytest.mark.req('FR-002')`.

---

### TC-002 through TC-005: AsyncNoteService, AsyncReminderService, AsyncWebhookService, AsyncInteractionService have no dedicated tests
**Auditor:** test-coverage-auditor | **Files:** affinity/services/v1_only.py

These async V1-only services lack dedicated test coverage.

---

### CLI-006 through CLI-014: SDK operations not exposed via CLI
**Auditor:** sdk-cli-consistency-auditor

**Status:** Implemented (2025-12-21)

- PersonService create/update/delete/merge now exposed via `affinity person ...`
- CompanyService create/update/delete/merge now exposed via `affinity company ...`
- ListService create now exposed via `affinity list create`
- ListEntryService write ops now exposed via `affinity list entry add/delete/update-field/batch-update`
- Field/FieldValue/RelationshipStrength/Task services now exposed via `affinity field`,
  `affinity field-value`, `affinity relationship-strength`, and `affinity task`

**Evidence:**
- `affinity/cli/commands/person_cmds.py`
- `affinity/cli/commands/company_cmds.py`
- `affinity/cli/commands/list_cmds.py`
- `affinity/cli/commands/field_cmds.py`
- `affinity/cli/commands/field_value_cmds.py`
- `affinity/cli/commands/relationship_strength_cmds.py`
- `affinity/cli/commands/task_cmds.py`
- `docs/public/cli/commands.md`
- `tests/test_cli_write_ops.py`

---

### ERR-007: Pydantic ValidationError from model_validate not wrapped
**Auditor:** error-handling-auditor | **File:** affinity/services/lists.py:184

**Status:** Implemented (2025-12-21)

List service response parsing now uses `_safe_model_validate(...)` to catch
Pydantic validation errors and raise `AffinityError` instead of leaking raw
exceptions to callers.

---

### DEP-001: Missing upper bound on httpx version
**Auditor:** dependency-health-auditor | **File:** pyproject.toml:40

The httpx dependency uses only a lower bound constraint (>=0.25.0) with no upper bound.

---

### DEP-002: Missing upper bound on pydantic version
**Auditor:** dependency-health-auditor | **File:** pyproject.toml:41

The pydantic dependency uses only a lower bound constraint (>=2.8.0) with no upper bound.

---

### DOC-005: sync-vs-async.md parity table missing rate_limits service
**Auditor:** documentation-auditor | **File:** docs/public/guides/sync-vs-async.md:32

---

## Low Priority / Suggestions

### API-013: AsyncEntityFileService.download() has deadline_seconds param, sync version does not
**Auditor:** api-parity-auditor | **File:** affinity/services/v1_only.py:1635

Minor parameter inconsistency between sync and async versions.

---

### TC-006 through TC-010: More async services without tests
**Auditor:** test-coverage-auditor

AsyncFieldService, AsyncFieldValueService, AsyncRelationshipStrengthService, AsyncRateLimitService, AsyncAuthService lack dedicated tests.

---

### CLI-015 through CLI-018: Minor CLI feature gaps
**Auditor:** sdk-cli-consistency-auditor

- PersonService.list not exposed via CLI
- CompanyService.list not exposed via CLI
- SDK search parameters not exposed in CLI
- EntityFileService upload commands not exposed

---

### SEC-002: Webhook parser does not validate sent_at timestamp
**Auditor:** security-auditor | **File:** affinity/inbound_webhooks.py:171

No validation for replay protection.

---

### ERR-004: No thundering herd prevention for rate-limited requests
**Auditor:** error-handling-auditor | **File:** affinity/clients/http.py:784

Enhancement opportunity for concurrent request handling.

---

### DEP-003: Vague version constraints for rich
**Auditor:** dependency-health-auditor | **File:** pyproject.toml:54

---

### DOC-006, DOC-007: README prints FieldValues repr instead of dict
**Auditor:** documentation-auditor | **Files:** README.md:100, README.md:176

---

## Positive Findings

The following positive observations were made across the audits:

### API Parity
- V1/V2 API routing is correctly implemented (reads use V2, writes use V1)
- All services consistently implement list()/all()/iter() pattern
- V1-only services have complete sync/async parity
- OpportunityService has complete sync/async parity

### Type Safety
- TypedIds provide static type safety via mypy
- OpenIntEnum/OpenStrEnum handle unknown values gracefully (forward-compatible)
- Models correctly map V1/V2 field differences

### Error Handling
- Exponential backoff with jitter implemented correctly
- Rate limit Retry-After header parsing is RFC-compliant
- Pagination loops are correctly detected and prevented
- API keys are properly redacted in diagnostics
- CLI error presentation is comprehensive with actionable hints

### Security
- TLS enforcement via HTTPS default URLs
- Authorization headers stripped on redirects
- Path traversal protection in downloads
- Config file permission warnings

### Dependencies
- Python 3.10-3.13 compatibility verified
- Conditional tomli dependency handled correctly

---

## Agent-Specific Details

### API Parity Audit
**Files Analyzed:** 8 | **Findings:** 17

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 7 |
| Medium | 0 |
| Low | 1 |
| Info | 9 |

### Type Safety Audit
**Files Analyzed:** 6 | **Findings:** 13

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 0 |
| Low | 0 |
| Info | 13 |

### Test Coverage Audit
**Files Analyzed:** 38 | **Findings:** 14

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 5 |
| Low | 4 |
| Info | 5 |

### SDK-CLI Consistency Audit
**Files Analyzed:** 18 | **Findings:** 21

| Severity | Count |
|----------|-------|
| Critical | 1 |
| High | 4 |
| Medium | 8 |
| Low | 5 |
| Info | 3 |

### Error Handling Audit
**Files Analyzed:** 12 | **Findings:** 15

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 1 |
| Low | 1 |
| Info | 13 |

### Documentation Audit
**Files Analyzed:** 51 | **Findings:** 8

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 4 |
| Medium | 1 |
| Low | 3 |
| Info | 0 |

### Security Audit
**Files Analyzed:** 52 | **Findings:** 3

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 0 |
| Low | 1 |
| Info | 2 |

### Dependency Health Audit
**Files Analyzed:** 1 | **Findings:** 5

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 2 |
| Low | 1 |
| Info | 2 |

---

## Excluded Findings

No findings were excluded in this audit (exclusions.yaml is empty).

---

## Audit Metadata

```yaml
baseline_commit: 1bb991745ae236d54531e46c9735608075653ac8
audit_timestamp: 2025-12-20T23:54:36Z
files_analyzed: 186
auditors_completed: 8/8
mode: full_audit
total_findings: 96
```
